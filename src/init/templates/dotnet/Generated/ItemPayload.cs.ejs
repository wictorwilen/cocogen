<% const graphNs = graphApiVersion === "beta" ? "Microsoft.Graph.Beta" : "Microsoft.Graph"; -%>
// Build ExternalItem payloads for Graph ingestion.
using <%= graphNs %>.Models.ExternalConnectors;
using <%= namespaceName %>.Core;

namespace <%= schemaNamespace %>;

/// <summary>
/// Maps schema model instances into Graph ExternalItem payloads.
/// </summary>
public static class ItemPayload
{
    private const string IdEncoding = "<%= idEncoding ?? "slug" %>";

    /// <summary>
    /// Resolve the external item ID for a schema model instance.
    /// </summary>
    public static string GetItemId(<%= itemTypeName %> item)
    {
        var raw = <%- itemIdExpression %>;
        return EncodeId(raw);
    }

    private static string EncodeId(string value)
    {
        return ItemId.GetItemId(value, IdEncoding);
    }

    /// <summary>
    /// Convert a schema model instance into a Graph ExternalItem payload.
    /// </summary>
    public static ExternalItem ToExternalItem(<%= itemTypeName %> item)
    {
        var props = new Properties
        {
            AdditionalData = new Dictionary<string, object>
            {
<%- propertiesObjectLines %>
            }
        };

        var externalItem = new ExternalItem
        {
            Id = GetItemId(item),
            Acl = new List<Acl>
            {
                new Acl
                {
                    Type = AclType.Everyone,
                    Value = "everyone",
                    AccessType = AccessType.Grant,
                }
            },
            Properties = props,
        };

    <%- contentBlock %>

        return externalItem;
    }
}

/// <summary>
/// Adapter for consuming ItemPayload through core abstractions.
/// </summary>
public sealed class ItemPayloadAdapter : IItemPayload<<%= itemTypeName %>>
{
    public string GetItemId(<%= itemTypeName %> item) => ItemPayload.GetItemId(item);

    public ExternalItem ToExternalItem(<%= itemTypeName %> item) => ItemPayload.ToExternalItem(item);
}
