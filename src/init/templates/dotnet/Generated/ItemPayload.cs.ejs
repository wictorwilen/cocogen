<% const graphNs = graphApiVersion === "beta" ? "Microsoft.Graph.Beta" : "Microsoft.Graph"; -%>
// Build ExternalItem payloads for Graph ingestion.
using System.Security.Cryptography;
using System.Text;
using System.Text.RegularExpressions;
using <%= graphNs %>.Models.ExternalConnectors;

namespace <%= schemaNamespace %>;

/// <summary>
/// Maps schema model instances into Graph ExternalItem payloads.
/// </summary>
public static class ItemPayload
{
    private const string IdEncoding = "<%= idEncoding ?? "slug" %>";

    /// <summary>
    /// Resolve the external item ID for a schema model instance.
    /// </summary>
    public static string GetItemId(<%= itemTypeName %> item)
    {
        var raw = <%- itemIdExpression %>;
        return EncodeId(raw);
    }

    private static string EncodeId(string value)
    {
        if (string.IsNullOrEmpty(value)) return string.Empty;
        return IdEncoding switch
        {
            "base64" => ToBase64Url(Encoding.UTF8.GetBytes(value)),
            "hash" => ToBase64Url(SHA256.HashData(Encoding.UTF8.GetBytes(value))),
            _ => Slugify(value),
        };
    }

    private static string ToBase64Url(byte[] bytes)
    {
        return Convert.ToBase64String(bytes)
            .TrimEnd('=')
            .Replace('+', '-')
            .Replace('/', '_');
    }

    private static string Slugify(string value)
    {
        var lower = value.Trim().ToLowerInvariant();
        var slug = Regex.Replace(lower, "[^a-z0-9]+", "-");
        slug = Regex.Replace(slug, "^-+|-+$", "");
        return slug;
    }

    /// <summary>
    /// Convert a schema model instance into a Graph ExternalItem payload.
    /// </summary>
    public static ExternalItem ToExternalItem(<%= itemTypeName %> item)
    {
        var props = new Properties
        {
            AdditionalData = new Dictionary<string, object>
            {
<%- propertiesObjectLines %>
            }
        };

        var externalItem = new ExternalItem
        {
            Id = GetItemId(item),
            Acl = new List<Acl>
            {
                new Acl
                {
                    Type = AclType.Everyone,
                    Value = "everyone",
                    AccessType = AccessType.Grant,
                }
            },
            Properties = props,
        };

    <%- contentBlock %>

        return externalItem;
    }
}
