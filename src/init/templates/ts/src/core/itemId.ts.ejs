import { createHash } from "node:crypto";

type ItemRecord = Record<string, unknown>;

export type IdEncoding = "slug" | "base64" | "hash";

export function toBase64Url(value: string | Buffer): string {
  const buffer = typeof value === "string" ? Buffer.from(value, "utf8") : value;
  return buffer
    .toString("base64")
    .replace(/\+/g, "-")
    .replace(/\//g, "_")
    .replace(/=+$/g, "");
}

export function slugify(value: string): string {
  const normalized = value.normalize("NFKD");
  const slug = normalized
    .toLowerCase()
    .replace(/[^a-z0-9]+/g, "-")
    .replace(/(^-+|-+$)/g, "");
  return slug;
}

export function encodeId(value: string, encoding: IdEncoding): string {
  if (encoding === "base64") return toBase64Url(value);
  if (encoding === "hash") return toBase64Url(createHash("sha256").update(value, "utf8").digest());
  return slugify(value);
}

export function getItemId(item: ItemRecord, idPropertyName: string, encoding: IdEncoding): string {
  const raw = (item as any).internalId ?? (item as any)[idPropertyName] ?? "";
  return encodeId(String(raw ?? ""), encoding);
}
