/**
 * Build ExternalItem payloads for Graph ingestion.
 */
import type { <%= itemTypeName %> } from "./model.js";
import { contentPropertyName, idPropertyName } from "./constants.js";
import { createHash } from "node:crypto";

const idEncoding: "slug" | "base64" | "hash" = <%= JSON.stringify(idEncoding ?? "slug") %>;

function toBase64Url(value: string | Buffer): string {
  const buffer = typeof value === "string" ? Buffer.from(value, "utf8") : value;
  return buffer
    .toString("base64")
    .replace(/\+/g, "-")
    .replace(/\//g, "_")
    .replace(/=+$/g, "");
}

function slugify(value: string): string {
  const normalized = value.normalize("NFKD");
  const slug = normalized
    .toLowerCase()
    .replace(/[^a-z0-9]+/g, "-")
    .replace(/(^-+|-+$)/g, "");
  return slug;
}

function encodeId(value: string): string {
  if (idEncoding === "base64") return toBase64Url(value);
  if (idEncoding === "hash") return toBase64Url(createHash("sha256").update(value, "utf8").digest());
  return slugify(value);
}

/**
 * Resolve the external item ID from the schema model.
 */
export function getItemId(item: <%= itemTypeName %>): string {
  const raw = (item as any).__cocoId ?? (item as any)[idPropertyName] ?? "";
  return encodeId(String(raw ?? ""));
}

/**
 * Convert a schema model instance into a Graph ExternalItem payload.
 */
export function toExternalItem(item: <%= itemTypeName %>): {
  id: string;
  acl: Array<{ type: string; value: string; accessType: string }>;
  properties: Record<string, unknown>;
  content: { type: string; value: string };
} {
  const properties = {
<%- propertiesObjectLines %>
  };

  return {
    id: getItemId(item),
    acl: [{ type: "everyone", value: "everyone", accessType: "grant" }],
    properties<%- contentBlock %>
  };
}
