/**
 * Build ExternalItem payloads for Graph ingestion.
 */
import type { <%= itemTypeName %> } from "./model.js";
import { contentPropertyName, idPropertyName } from "./constants.js";
import { getItemId as getItemIdFromCore, type IdEncoding } from "../core/itemId.js";
<% if (peopleSerializers.length > 0) { -%>
import { <%= peopleSerializers.join(", ") %> } from "../core/people.js";
<% } -%>

const idEncoding: IdEncoding = <%= JSON.stringify(idEncoding ?? "slug") %>;

<% if (usesPrincipal) { -%>
const cleanPrincipal = (
  value: Record<string, unknown> | null | undefined
): Record<string, unknown> | null | undefined => {
  if (!value) return value;
  return Object.fromEntries(Object.entries(value).filter(([, v]) => v !== null && v !== undefined));
};

const cleanPrincipalCollection = (
  values: Array<Record<string, unknown>> | null | undefined
): Array<Record<string, unknown>> | null | undefined => {
  if (!values) return values;
  return values
    .filter((value): value is Record<string, unknown> => Boolean(value))
    .map((value) => cleanPrincipal(value) ?? value);
};
<% } -%>

/**
 * Resolve the external item ID from the schema model.
 */
export function getItemId(item: <%= itemTypeName %>): string {
  return getItemIdFromCore(item as unknown as Record<string, unknown>, idPropertyName, idEncoding);
}

/**
 * Convert a schema model instance into a Graph ExternalItem payload.
 */
export function toExternalItem(item: <%= itemTypeName %>): {
  id: string;
  acl: Array<{ type: string; value: string; accessType: string }>;
  properties: Record<string, unknown>;
  content: { type: string; value: string };
} {
  const properties = {
<% for (const prop of properties) { -%>
<% if (prop.odataType) { -%>
    <%= JSON.stringify(`${prop.name}@odata.type`) %>: <%= JSON.stringify(prop.odataType) %>,
<% } -%>
    <%= JSON.stringify(prop.name) %>: <%- prop.valueExpression %>,
<% } -%>
  };

  return {
    id: getItemId(item),
    acl: [{ type: "everyone", value: "everyone", accessType: "grant" }],
    properties,
    content: {
      type: "text",
      value: <%- contentValueExpression %>,
    },
  };
}
