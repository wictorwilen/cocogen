/**
 * Row value parsing helpers used by generated transforms.
 */
<% if (inputFormat !== "csv") { -%>
import { JSONPath } from "jsonpath-plus";
import { normalizeJsonPath } from "./inputPath.js";
<% } -%>

type SourceKey = string | string[];
/** Parse any row value into a string (empty when nullish). */
function parseString(value: unknown): string {
  if (value === undefined || value === null) return "";
  if (typeof value === "object") {
    try {
      return JSON.stringify(value);
    } catch {
      return "";
    }
  }
  return String(value);
}

/** Parse a numeric row value into a number (defaults to 0). */
function parseNumber(value: unknown): number {
  const text = parseString(value).trim();
  if (!text) return 0;
  const numberValue = Number(text);
  return Number.isFinite(numberValue) ? numberValue : 0;
}

/** Parse a boolean-ish row value into a boolean. */
function parseBoolean(value: unknown): boolean {
  const text = parseString(value).trim().toLowerCase();
  return text === "true" || text === "1" || text === "yes";
}

/** Split a delimited row value into an array of strings. */
function splitCollection(value: unknown): string[] {
  const text = parseString(value).trim();
  if (!text) return [];
  return text.split(/\s*;\s*/).map((s) => s.trim()).filter(Boolean);
}

/** Parse a string collection from a row value. */
function parseStringCollection(value: unknown): string[] {
  if (Array.isArray(value)) {
    return value.map((entry) => parseString(entry)).filter((entry) => entry.length > 0);
  }
  return splitCollection(value);
}

/** Parse a number collection from a row value. */
function parseNumberCollection(value: unknown): number[] {
  if (Array.isArray(value)) {
    return value.map((entry) => parseNumber(entry));
  }
  return splitCollection(value).map((s) => parseNumber(s));
}

/** Read a value from a row using CSV headers or JSONPath. */
function readSourceValue(row: Record<string, unknown>, source: SourceKey): unknown {
  if (Array.isArray(source)) {
    if (source.length === 0) return "";
    return row[source[0]!];
  }
  <% if (inputFormat === "csv") { -%>
  return "";
  <% } else { -%>
  const path = normalizeJsonPath(source);
  if (!path) return "";
  try {
    const result = JSONPath({ path, json: row, wrap: false });
    return result ?? "";
  } catch {
    return "";
  }
  <% } -%>
}

export {
  parseString,
  parseNumber,
  parseBoolean,
  parseStringCollection,
  parseNumberCollection,
  readSourceValue
};