/**
 * Default CSV datasource implementation.
 */
import { createReadStream } from "node:fs";
import { parse } from "csv-parse";

import type { <%= itemTypeName %> } from "../<%= schemaFolderName %>/model.js";
import type { ItemSource } from "./itemSource.js";
import { fromRow } from "../<%= schemaFolderName %>/fromRow.js";

/**
 * CSV-based datasource (default). Replace with your own ItemSource as needed.
 */
export class CsvItemSource implements ItemSource<<%= itemTypeName %>> {
  constructor(private readonly filePath: string) {}

  /**
   * Stream items from the CSV file and map each row to the schema model.
   */
  async *getItems(): AsyncIterable<<%= itemTypeName %>> {
    const parser = parse({
      columns: true,
      skip_empty_lines: true,
      trim: true
    });

    const stream = createReadStream(this.filePath, { encoding: "utf8" }).pipe(parser);

    for await (const row of stream as AsyncIterable<Record<string, unknown>>) {
      yield fromRow(row);
    }
  }
}
